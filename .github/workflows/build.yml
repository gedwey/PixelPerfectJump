name: Build

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PROJECT_NAME: PixelPerfectJump

jobs:
  build:
    runs-on: arc-runner-set

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install deps
        run: |
          sudo apt update -y
          sudo apt install -y curl git build-essential p7zip-full
          sudo mkdir /usr/share/dotnet
          sudo chmod 777 /usr/share/dotnet
          
      - name: Setup dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.x'

      - name: Download Dalamud
        run: |
          curl -o latest.zip https://goatcorp.github.io/dalamud-distrib/net7/latest.zip
          7z x latest.zip dalamud
          rm latest.zip

      - name: Build
        run: |
          dotnet restore
          dotnet build --configuration Release --nologo --output bin/
        env:
          DOTNET_CLI_TELEMETRY_OUTPUT: true

      - name: Create artifact
        run: |
          7z a bin/* PixelPerfectJump.zip

      - uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: false
          title: "Release"
          files: PixelPerfectJump.zip
